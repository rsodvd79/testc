<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mail Viewer</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; height: 100vh; display: grid; grid-template-rows: 48px 1fr; }
    header { background: #0f172a; color: white; display: flex; align-items: center; padding: 0 12px; }
    header nav { margin-left: auto; }
    header nav a { color: #cbd5f5; text-decoration: none; font-size: 13px; }
    header nav a:hover { color: #ffffff; }
    main { display: grid; grid-template-columns: 240px 220px 260px 1fr; height: 100%; }
    aside, nav, section { border-right: 1px solid #e2e8f0; overflow: auto; }
    section { border-right: none; }
    h2 { font-size: 14px; margin: 8px 12px; color: #475569; }
    ul { list-style: none; padding: 0; margin: 0; }
    li { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f1f5f9; }
    li:hover { background: #f8fafc; }
    .msg { padding: 12px; }
    .meta { font-size: 12px; color: #475569; margin-bottom: 8px; }
    .subject { font-weight: 600; margin-bottom: 8px; }
    iframe { width: 100%; height: calc(100% - 140px); border: 0; background: white; }
    .attachments a { display: inline-block; margin-right: 8px; font-size: 12px; }
  </style>
  <script>
    const encodePathSegments = (value) => {
      if (!value) return '';
      const parts = Array.isArray(value) ? value : value.replace(/\\/g, '/').split('/');
      return parts.filter(part => part !== undefined && part !== null && part !== '').map(part => encodeURIComponent(part)).join('/');
    };

    async function loadAccounts() {
      const res = await fetch('/api/accounts');
      const accounts = await res.json();
      const ul = document.getElementById('accounts');
      ul.innerHTML = '';
      accounts.forEach(a => {
        const li = document.createElement('li'); li.textContent = a; li.onclick = () => selectAccount(a);
        ul.appendChild(li);
      });
    }

    async function selectAccount(a) {
      window.currentAccount = a;
      const res = await fetch(`/api/folders/${encodeURIComponent(a)}`);
      const folders = await res.json();
      const ul = document.getElementById('folders');
      ul.innerHTML = '';
      folders.sort().forEach(f => {
        const normalized = f.replace(/\\/g, '/');
        const segments = normalized.split('/');
        const depth = Math.max(0, segments.length - 1);
        const name = segments[segments.length - 1] || normalized;
        const li = document.createElement('li');
        li.textContent = name;
        li.style.paddingLeft = `${12 + depth * 16}px`;
        li.dataset.path = normalized;
        li.onclick = () => selectFolder(normalized);
        ul.appendChild(li);
      });
    }

    async function selectFolder(f) {
      const normalized = f.replace(/\\/g, '/');
      window.currentFolder = normalized;
      const folderParam = encodePathSegments(normalized);
      const url = `/api/messages/${encodeURIComponent(window.currentAccount)}/${folderParam}`;
      const res = await fetch(url);
      if (!res.ok) {
        console.error('Failed to load messages', await res.text());
        return;
      }
      const msgs = await res.json();
      const ul = document.getElementById('messages');
      ul.innerHTML = '';
      msgs.forEach(m => {
        const sizeKb = Math.max(1, Math.round(m.size / 1024));
        const display = m.subject && m.subject.trim() !== '' ? m.subject.trim() : m.id;
        const li = document.createElement('li');
        li.textContent = `${display} (${sizeKb} KB)`;
        if (m.sent) {
          li.textContent += ` - ${m.sent}`;
        }
        li.title = li.textContent;
        li.onclick = () => selectMessage(m.file);
        ul.appendChild(li);
      });
    }

    async function selectMessage(file) {
      const rawPath = `${window.currentFolder}/${file}`;
      const encodedPath = encodePathSegments(rawPath.split('/'));
      const res = await fetch(`/api/message/${encodeURIComponent(window.currentAccount)}/${encodedPath}`);
      if (!res.ok) {
        console.error('Failed to load message', await res.text());
        return;
      }
      const data = await res.json();
      document.getElementById('subject').textContent = data.headers.subject || '';
      document.getElementById('meta').textContent = `${data.headers.from} -> ${data.headers.to} | ${data.headers.date}`;
      const doc = document.getElementById('body').contentDocument;
      doc.open(); doc.write(data.body || '<pre style="white-space:pre-wrap"></pre>'); doc.close();
      const att = document.getElementById('attachments'); att.innerHTML = '';
      const linkBase = encodedPath;
      data.attachments.forEach(a => {
        const link = document.createElement('a'); link.textContent = a.name; link.href = `/api/attachment/${encodeURIComponent(window.currentAccount)}/${linkBase}?index=${a.index}`; link.target = '_blank';
        att.appendChild(link);
      });
    }

    window.onload = loadAccounts;
  </script>
  </head>
<body>
  <header>
    <strong>Mail Viewer</strong>
    <nav><a href="search.html">Ricerca</a></nav>
  </header>
  <main>
    <aside>
      <h2>Caselle</h2>
      <ul id="accounts"></ul>
    </aside>
    <nav class="folders">
      <h2>Cartelle</h2>
      <ul id="folders"></ul>
    </nav>
    <nav class="messages">
      <h2>Messaggi</h2>
      <ul id="messages"></ul>
    </nav>
    <section>
      <div class="msg">
        <div class="subject" id="subject"></div>
        <div class="meta" id="meta"></div>
        <div class="attachments" id="attachments"></div>
      </div>
      <iframe id="body"></iframe>
    </section>
  </main>
</body>
</html>

