<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mail Viewer</title>
  <style>
:root {
  --bg: #0f172a;
  --bg-light: #f1f5f9;
  --panel: #ffffff;
  --border: #dce1ee;
  --text: #0f172a;
  --muted: #64748b;
  --accent: #2563eb;
  --accent-dark: #1d4ed8;
  --accent-soft: rgba(37, 99, 235, 0.12);
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  min-height: 100vh;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  font-family: "Segoe UI", Roboto, system-ui, -apple-system, sans-serif;
  background: var(--bg-light);
  color: var(--text);
}

header {
  background: linear-gradient(140deg, var(--bg) 0%, #1e293b 100%);
  color: #f8fafc;
  padding: 20px 28px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 20px;
  box-shadow: 0 8px 24px rgba(15, 23, 42, 0.28);
}

.brand {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.brand h1 {
  margin: 0;
  font-size: 24px;
  font-weight: 700;
}

.brand span {
  font-size: 13px;
  color: rgba(248, 250, 252, 0.75);
}

header nav {
  display: flex;
  gap: 12px;
}

header nav a {
  color: rgba(248, 250, 252, 0.9);
  text-decoration: none;
  font-size: 14px;
  padding: 8px 18px;
  border-radius: 999px;
  border: 1px solid rgba(248, 250, 252, 0.22);
  transition: background 0.2s ease, color 0.2s ease;
}

header nav a:hover {
  background: rgba(248, 250, 252, 0.16);
  color: #ffffff;
}

main {
  flex: 1;
  min-height: 0;
  padding: 28px 30px 34px;
  display: grid;
  overflow: auto;
  grid-template-columns: 260px 240px 280px minmax(0, 1fr);
  gap: 22px;
}

.panel {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 18px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-height: 0;
  box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
}

.panel-header {
  padding: 18px 20px 14px;
  border-bottom: 1px solid var(--border);
  font-size: 15px;
  font-weight: 600;
  color: var(--text);
}

.scroll {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
  position: relative;
}

.loader {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(241, 245, 249, 0.72);
  backdrop-filter: blur(2px);
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  transition: opacity 0.2s ease;
  z-index: 2;
}

.loader.visible {
  opacity: 1;
  visibility: visible;
  pointer-events: auto;
}

.loader .spinner {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 3px solid rgba(37, 99, 235, 0.25);
  border-top-color: var(--accent);
  animation: spin 0.9s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.viewer-body {
  flex: 1;
  position: relative;
  display: flex;
  background: #ffffff;
  overflow: hidden;
}

.list {
  list-style: none;
  margin: 0;
  padding: 0;
}

.list li {
  padding: 12px 18px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background 0.15s ease;
  font-size: 14px;
  color: var(--text);
}

.list li:hover {
  background: #f6f7fb;
}

.list li:last-child {
  border-bottom: none;
}

.viewer {
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.viewer-info {
  padding: 22px 24px 18px;
  border-bottom: 1px solid var(--border);
}

.viewer-info .subject {
  margin: 0 0 10px;
  font-size: 20px;
  font-weight: 600;
}

.viewer-info .meta {
  font-size: 13px;
  color: var(--muted);
  margin-bottom: 12px;
}

.viewer-info .attachments {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.viewer-info .attachments a {
  font-size: 12px;
  color: var(--accent);
  text-decoration: none;
  padding: 6px 10px;
  border: 1px solid var(--accent);
  border-radius: 999px;
  transition: background 0.2s ease, color 0.2s ease;
}

.viewer-info .attachments a:hover {
  background: var(--accent);
  color: #ffffff;
}

iframe {
  flex: 1;
  border: none;
  width: 100%;
  height: 100%;
  background: #ffffff;
}

@media (max-width: 1200px) {
  main {
    grid-template-columns: repeat(2, minmax(0, 1fr));
    grid-template-rows: auto auto;
  }

  .panel.accounts,
  .panel.folders,
  .panel.messages {
    min-height: 320px;
  }

  .viewer {
    grid-column: 1 / -1;
    min-height: 420px;
  }
}

@media (max-width: 900px) {
  main {
    grid-template-columns: 1fr;
  }

  .panel.accounts,
  .panel.folders,
  .panel.messages,
  .viewer {
    grid-column: 1 / -1;
  }
}
</style>
</head>
<body data-view-version="1.3">
  <header>
    <div class="brand">
      <h1>Mail Viewer</h1>
      <span>Esplora caselle, cartelle e messaggi archiviati</span>
    </div>
    <nav>
      <a href="search.html">Ricerca Messaggi</a>
      <a href="admin.html">Admin</a>
    </nav>
  </header>
  <main>
    <section class="panel accounts">
      <div class="panel-header">Caselle</div>
      <div class="scroll">
        <ul class="list" id="accounts"></ul>
      </div>
    </section>
    <section class="panel folders">
      <div class="panel-header">Cartelle</div>
      <div class="scroll">
        <div class="loader" id="foldersLoader" aria-hidden="true">
          <div class="spinner"></div>
        </div>
        <ul class="list" id="folders"></ul>
      </div>
    </section>
    <section class="panel messages">
      <div class="panel-header">Messaggi</div>
      <div class="scroll">
        <div class="loader" id="messagesLoader" aria-hidden="true">
          <div class="spinner"></div>
        </div>
        <ul class="list" id="messages"></ul>
      </div>
    </section>
    <section class="panel viewer">
      <div class="viewer-info">
        <h2 class="subject" id="subject"></h2>
        <div class="meta" id="meta"></div>
        <div class="attachments" id="attachments"></div>
      </div>
      <div class="viewer-body">
        <div class="loader" id="viewerLoader" aria-hidden="true">
          <div class="spinner"></div>
        </div>
        <iframe id="body"></iframe>
      </div>
    </section>
  </main>
<script>

    const encodePathSegments = (value) => {
      if (!value) return '';
      const parts = Array.isArray(value) ? value : value.replace(/\\/g, '/').split('/');
      return parts.filter(part => part !== undefined && part !== null && part !== '').map(part => encodeURIComponent(part)).join('/');
    };

    const ui = {
      accountsList: document.getElementById('accounts'),
      foldersList: document.getElementById('folders'),
      foldersLoader: document.getElementById('foldersLoader'),
      messagesList: document.getElementById('messages'),
      messagesLoader: document.getElementById('messagesLoader'),
      subject: document.getElementById('subject'),
      meta: document.getElementById('meta'),
      attachments: document.getElementById('attachments'),
      viewerFrame: document.getElementById('body'),
      viewerLoader: document.getElementById('viewerLoader')
    };

    const toggleLoader = (section, isVisible) => {
      const loader = ui[`${section}Loader`];
      if (!loader) return;
      loader.classList.toggle('visible', isVisible);
    };

    const renderViewerContent = (html) => {
      const doc = ui.viewerFrame.contentDocument;
      doc.open();
      doc.write(html);
      doc.close();
    };

    const showViewerError = () => {
      renderViewerContent('<div style="font-family:Segoe UI,Roboto,sans-serif;padding:24px;color:#b91c1c;">Impossibile caricare il messaggio.</div>');
      ui.attachments.innerHTML = '';
      ui.subject.textContent = '';
      ui.meta.textContent = '';
    };

    async function loadAccounts() {
      const res = await fetch('/api/accounts');
      const accounts = await res.json();
      ui.accountsList.innerHTML = '';
      accounts.forEach(a => {
        const li = document.createElement('li');
        li.textContent = a;
        li.onclick = () => selectAccount(a);
        ui.accountsList.appendChild(li);
      });
    }

    async function selectAccount(a) {
      window.currentAccount = a;
      window.currentFolder = null;
      toggleLoader('folders', true);
      ui.foldersList.innerHTML = '';
      ui.messagesList.innerHTML = '';
      try {
        const res = await fetch(`/api/folders/${encodeURIComponent(a)}`);
        if (!res.ok) {
          console.error('Failed to load folders', await res.text());
          return;
        }
        const folders = await res.json();
        folders.sort().forEach(f => {
          const normalized = f.replace(/\\/g, '/');
          const segments = normalized.split('/');
          const depth = Math.max(0, segments.length - 1);
          const name = segments[segments.length - 1] || normalized;
          const li = document.createElement('li');
          li.textContent = name;
          li.style.paddingLeft = `${12 + depth * 16}px`;
          li.dataset.path = normalized;
          li.onclick = () => selectFolder(normalized);
          ui.foldersList.appendChild(li);
        });
      } catch (err) {
        console.error('Failed to load folders', err);
      } finally {
        toggleLoader('folders', false);
      }
    }

    async function selectFolder(f) {
      if (!window.currentAccount) return;
      const normalized = f.replace(/\\/g, '/');
      window.currentFolder = normalized;
      toggleLoader('messages', true);
      ui.messagesList.innerHTML = '';
      const folderParam = encodePathSegments(normalized);
      const url = `/api/messages/${encodeURIComponent(window.currentAccount)}/${folderParam}`;
      try {
        const res = await fetch(url);
        if (!res.ok) {
          console.error('Failed to load messages', await res.text());
          return;
        }
        const msgs = await res.json();
        msgs.forEach(m => {
          const sizeKb = Math.max(1, Math.round(m.size / 1024));
          const display = m.subject && m.subject.trim() !== '' ? m.subject.trim() : m.id;
          const li = document.createElement('li');
          li.textContent = `${display} (${sizeKb} KB)`;
          if (m.sent) {
            li.textContent += ` - ${m.sent}`;
          }
          li.title = li.textContent;
          li.onclick = () => selectMessage(m.file);
          ui.messagesList.appendChild(li);
        });
      } catch (err) {
        console.error('Failed to load messages', err);
      } finally {
        toggleLoader('messages', false);
      }
    }

    async function selectMessage(file) {
      if (!window.currentAccount || !window.currentFolder) return;
      const rawPath = `${window.currentFolder}/${file}`;
      const encodedPath = encodePathSegments(rawPath.split('/'));
      toggleLoader('viewer', true);
      ui.attachments.innerHTML = '';
      try {
        const res = await fetch(`/api/message/${encodeURIComponent(window.currentAccount)}/${encodedPath}`);
        if (!res.ok) {
          console.error('Failed to load message', await res.text());
          showViewerError();
          return;
        }
        const data = await res.json();
        ui.subject.textContent = data.headers.subject || '';
        ui.meta.textContent = `${data.headers.from} -> ${data.headers.to} | ${data.headers.date}`;
        renderViewerContent(data.body || '<pre style="white-space:pre-wrap"></pre>');
        const linkBase = encodedPath;
        data.attachments.forEach(a => {
          const link = document.createElement('a');
          link.textContent = a.name;
          link.href = `/api/attachment/${encodeURIComponent(window.currentAccount)}/${linkBase}?index=${a.index}`;
          link.target = '_blank';
          ui.attachments.appendChild(link);
        });
      } catch (err) {
        console.error('Failed to load message', err);
        showViewerError();
      } finally {
        toggleLoader('viewer', false);
      }
    }

    window.onload = loadAccounts;

</script>
</body>
</html>
